<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ルート録音ツール（ブラウザでGPSログ）</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="anonymous">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin="anonymous"></script>

<style>
  html,body{height:100%;margin:0;font-family:system-ui,Segoe UI,Roboto,Meiryo,sans-serif}
  #map{height:65vh}
  .bar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;padding:8px 10px}
  .mono{font-family:ui-monospace,Consolas,Menlo,monospace}
  button{padding:8px 12px;cursor:pointer}
  input[type=number]{width:7em;padding:6px}
  .stat{padding:6px 10px}
  .warn{color:#b00}
</style>
</head>
<body>
<div class="bar">
  精度≦<input id="maxAcc" type="number" value="25" min="1" step="1"> m
  最小移動≧<input id="minDist" type="number" value="5" min="0" step="1"> m
  <button id="btnStart">記録開始</button>
  <button id="btnPause" disabled>一時停止</button>
  <button id="btnStop" disabled>記録停止</button>
  <button id="btnWake" title="画面スリープ防止のON/OFF">スリープ防止OFF</button>
  <span id="status" class="mono"></span>
</div>

<div id="map" aria-label="地図"></div>

<div class="bar">
  <button id="saveGeoJSON" disabled>GeoJSON保存</button>
  <button id="saveGPX" disabled>GPX保存</button>
  <button id="saveCSV" disabled>CSV保存</button>
  <button id="btnClear" disabled>クリア</button>
  <span class="stat mono" id="stats">pts:0 | dist:0 m | avg:0 km/h | cur:0 km/h | acc:–</span>
</div>

<script>
const $ = (id)=>document.getElementById(id);

// ---- 地図 ----
const map = L.map('map').setView([35.0,135.86], 14);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'&copy; OpenStreetMap'}).addTo(map);
const routeLine = L.polyline([], {color:'#0aa', weight:5}).addTo(map);
const curMarker = L.circleMarker([35.0,135.86], {radius:6, color:'#07a', fillColor:'#07a', fillOpacity:1}).addTo(map);
let accCircle = L.circle([35.0,135.86], {radius:0, color:'#999', weight:1, fillOpacity:0.05}).addTo(map);

// ---- 記録データ ----
let watchId = null;
let points = [];  // {lat,lng,time,acc}
let distance = 0; // meters
let startTime = null;
let lastPoint = null;
let paused = false;
let wakeLock = null;

// ---- ユーティリティ ----
const rad = x=>x*Math.PI/180;
function haversine(a,b){
  const R=6371000, dLat=rad(b.lat-a.lat), dLng=rad(b.lng-a.lng);
  const s1=Math.sin(dLat/2), s2=Math.sin(dLng/2);
  const aa=s1*s1 + Math.cos(rad(a.lat))*Math.cos(rad(b.lat))*s2*s2;
  return 2*R*Math.asin(Math.min(1,Math.sqrt(aa)));
}
function fmtKmh(mps){ return (mps*3.6).toFixed(1); }
function updateStats(curSpeedMps, acc){
  const elapsed = startTime ? (Date.now()-startTime)/1000 : 0;
  const avg = elapsed>0 ? (distance/elapsed) : 0;
  $('#stats').textContent = `pts:${points.length} | dist:${distance.toFixed(0)} m | avg:${fmtKmh(avg)} km/h | cur:${fmtKmh(curSpeedMps||0)} km/h | acc:${acc?.toFixed?.(0)??'–'} m`;
}
function setStatus(s, warn=false){
  $('#status').textContent = s || '';
  $('#status').className = 'mono' + (warn?' warn':'');
}
async function toggleWakeLock(){
  try{
    if (!('wakeLock' in navigator)) { setStatus('Wake Lock未対応（電源設定に注意）', true); return; }
    if (wakeLock) { await wakeLock.release(); wakeLock=null; $('#btnWake').textContent='スリープ防止OFF'; return; }
    wakeLock = await navigator.wakeLock.request('screen');
    wakeLock.addEventListener('release', ()=>{ $('#btnWake').textContent='スリープ防止OFF'; wakeLock=null; });
    $('#btnWake').textContent='スリープ防止ON';
  }catch(e){
    setStatus('スリープ防止に失敗: '+e.message, true);
  }
}

// ---- 位置受信 ----
function onPos(pos){
  if (paused) return;
  const {latitude:lat, longitude:lng, accuracy} = pos.coords;
  const t = Date.now();
  const maxAcc = Number($('#maxAcc').value)||25;
  const minDist = Number($('#minDist').value)||0;

  // 精度フィルタ
  if (accuracy && accuracy > maxAcc) {
    setStatus(`精度${accuracy.toFixed(0)}m>閾値${maxAcc}m: スキップ`);
    updateStats(0, accuracy);
    return;
  }

  // 最小移動距離フィルタ
  const cur = {lat, lng};
  if (lastPoint) {
    const d = haversine(lastPoint, cur);
    if (d < minDist) {
      setStatus(`移動${d.toFixed(1)}m<閾値${minDist}m: スキップ`);
      updateStats(0, accuracy);
      // 表示だけ更新
      curMarker.setLatLng([lat,lng]); accCircle.setLatLng([lat,lng]).setRadius(accuracy||0);
      map.panTo([lat,lng], {animate:false});
      return;
    }
    distance += d;
  } else {
    // 初回は地図センター＆開始時間
    startTime = t;
    distance = 0;
  }

  // データ確定
  lastPoint = cur;
  points.push({lat,lng,time:new Date(t).toISOString(), acc:accuracy||null});

  // 表示更新
  routeLine.addLatLng([lat,lng]);
  curMarker.setLatLng([lat,lng]);
  accCircle.setLatLng([lat,lng]).setRadius(accuracy||0);
  if (points.length===1) map.setView([lat,lng], 16, {animate:false});
  else map.panTo([lat,lng], {animate:false});

  // 速度は前回点からの推定
  const curSpeed = (points.length>=2)
    ? haversine(points.at(-2), points.at(-1)) / ((new Date(points.at(-1).time) - new Date(points.at(-2).time))/1000 || 1)
    : 0;

  updateStats(curSpeed, accuracy);
  $('#saveGeoJSON').disabled = $('#saveGPX').disabled = $('#saveCSV').disabled = $('#btnClear').disabled = (points.length===0);
}

function onPosErr(err){
  setStatus(`位置取得エラー: ${err.message}`, true);
}

// ---- 記録制御 ----
function start(){
  if (watchId) navigator.geolocation.clearWatch(watchId);
  paused = false;
  setStatus('記録中…（ブラウザを前面に保つと安定）');
  watchId = navigator.geolocation.watchPosition(onPos, onPosErr, {
    enableHighAccuracy: true,
    maximumAge: 0,
    timeout: 20000
  });
  $('#btnStart').disabled = true;
  $('#btnPause').disabled = false;
  $('#btnStop').disabled  = false;
}
function pause(){
  paused = !paused;
  $('#btnPause').textContent = paused ? '再開' : '一時停止';
  setStatus(paused ? '一時停止中' : '記録中…');
}
function stop(){
  if (watchId){ navigator.geolocation.clearWatch(watchId); watchId=null; }
  paused = false;
  $('#btnStart').disabled = false;
  $('#btnPause').disabled = true; $('#btnPause').textContent='一時停止';
  $('#btnStop').disabled  = true;
  setStatus('停止しました。保存ボタンで書き出せます。');
}

// ---- 保存 ----
function download(name, text, type='application/octet-stream'){
  const blob = new Blob([text], {type});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download=name; a.click();
  URL.revokeObjectURL(url);
}
function saveGeoJSON(){
  const coords = points.map(p=>[p.lng, p.lat]); // GeoJSONは [lng,lat]
  const gj = {
    type:'FeatureCollection',
    features:[{
      type:'Feature',
      properties:{
        name:'recorded',
        start_time: points[0]?.ti_
